USE laboratorio_evaluados;

INSERT INTO `departamento_residencia` VALUES (1,1,'Guatemala'),(3,1,'Chimaltenango'),(4,1,'Escuintla'),(5,1,'Santa Rosa'),(6,1,'Sololá'),(7,1,'Totonicapán'),(8,1,'Quetzaltenango'),(9,1,'Suchitepéquez'),(10,1,'Retalhuleu'),(11,1,'San Marcos'),(12,1,'Huehuetenango'),(13,1,'Quiché'),(14,1,'Baja Verapaz'),(15,1,'Alta Verapaz'),(16,1,'Izabal'),(17,1,'Peten'),(18,1,'Zacapa'),(19,1,'Chiquimula'),(20,1,'Jutiapa'),(21,1,'Jalapa'),(22,1,'El Progreso');

INSERT INTO `comando` VALUES (1,1,'Auditoría Militar de Cuentas'),(2,1,'Brigada de Operaciones para Montaña'),(3,1,'Brigada de Fuerzas Especiales GBPNH'),(4,1,'Brigada de Infantería de Marina'),(5,1,'Brigada de Paracaidistas G.F.C.'),(6,1,'Brigada Especial de Operaciones de Selva TCIVAQA'),(7,1,'Brigada Humanitaria y de Rescate CFAC'),(8,1,'Brigada Militar Mariscal Zavala'),(9,1,'Centro de Adiestramiento del Ejército de Guatemala'),(10,1,'Centro de Atención a Discapacitados del Ejército de Guatemala'),(11,1,'Centro de las Fuerzas Armadas Centroamericanas'),(12,1,'Centro Médico Militar'),(13,1,'Comandancia Fuerza Aérea Guatemalteca'),(14,1,'Comandancia Marina Defensa Nacional'),(15,1,'Comando Aéreo Central La Aurora'),(16,1,'Comando Aéreo del Norte TCDEHS, Petén'),(17,1,'Comando Aéreo del Sur CMEVM, Retalhuleu'),(18,1,'Comando de Apoyo Logístico'),(19,1,'Comando de Comunicaciones del Ejército'),(20,1,'Comando de Fuerza Especial Naval'),(21,1,'Comando de Informática y Tecnología'),(22,1,'Comando Naval del Pacífico, Escuintla'),(23,1,'Comando Regional de Entrenamiento de Operaciones de Mantenimiento de Paz'),(24,1,'Comando Superior de Educación del Ejército'),(25,1,'Cuarta Brigada Infantería G.J.R.B.'),(26,1,'Cuerpo de Ingenieros del Ejército T.C.E I. F.V.A'),(27,1,'Cuerpo de Transporte del Ejército de Guatemala'),(28,1,'Dirección General de Derechos Humanos MDN'),(29,1,'Dirección de Inteligencia del EMDN'),(30,1,'Dirección de Logística del EMDN'),(31,1,'Dirección de Operaciones de Paz del EMDN'),(32,1,'Dirección de Operaciones del EMDN'),(33,1,'Dirección de Personal del EMDN'),(34,1,'Dirección de Planificación Estratégica del EMDN'),(35,1,'Dirección General Administrativa del EMDN'),(36,1,'Dirección General Administrativa del MDN'),(37,1,'Dirección General de Asuntos Jurídicos MDN'),(38,1,'Dirección General de Asuntos Marítimos del MDN'),(39,1,'Dirección General de Capitanías de Puertos del MDN'),(40,1,'Dirección General de Compras y Adquisiciones del MDN'),(41,1,'Dirección General de Control de Armas y Municiones del MDN'),(42,1,'Dirección General de Deportes y Recreación del MDN'),(43,1,'Dirección General de Especies Estancadas MDN'),(44,1,'Dirección General de Finanzas del MDN'),(45,1,'Dirección General de Política de Defensa del MDN'),(46,1,'Dirección General de Prensa del MDN'),(47,1,'Dirección General Integral de Gestión del MDN'),(48,1,'Dirección Relaciones Civiles Militares EMDN'),(49,1,'Escuela Militar de Aviación'),(50,1,'Escuela Naval de Guatemala'),(51,1,'Escuela Politécnica'),(52,1,'Escuela Técnica Militar de Aviación'),(53,1,'Estado Mayor Personal del M.D.N.'),(54,1,'Estado Mayor Personal del JEMDN.'),(55,1,'Estado Mayor Personal del SUBJEMDN.'),(56,1,'Estado Mayor Personal del Vice M.D.N.'),(57,1,'Estado Mayor Personal del Vice Marina.D.N.'),(58,1,'Fábrica de Municiones del Ejército'),(59,1,'Guardia Presidencial'),(60,1,'Hospital de la Fuerza Aérea Guatemalteca NSVL'),(61,1,'Industria Militar del Ejército'),(62,1,'Inspectoría General de las Fuerzas Armadas'),(63,1,'Inspectoría General de Medicina Militar'),(64,1,'Inspectoría General del Ejército de Guatemala'),(65,1,'Inspectoría General del MDN'),(66,1,'Ministerio de la Defensa Nacional'),(67,1,'Parque de Material de Guerra del Ejército'),(68,1,'Primera Brigada de Infantería G.M.A'),(69,1,'Primera Brigada de la Policía Militar Guardia de Honor'),(70,1,'Secretaría de Asuntos Administrativos del M.D.N'),(71,1,'Secretaría de Asuntos de Género del MDN'),(72,1,'Secretaría de Coordinación del M.D.N'),(73,1,'Secretaría de la Jefatura del Estado Mayor de la Defensa Nacional'),(74,1,'Segunda Brigada de Infantería G.L.D'),(75,1,'Tercera Brigada de Infantería G.E.T.B'),(76,1,'Unidad de Control de Reservas Militares del Ejército'),(77,1,'Unidad de Control de Reservas Militares MDN'),(78,1,'Unidad de Desastres Naturales del Ejército'),(79,1,'Unidad de Desminado Humanitario del Ejército'),(80,1,'Unidad de Derechos Humanos del Ejército'),(81,1,'Unidad de Mantenimiento de Paz del Ejército'),(82,1,'Unidad de Seguridad de Fronteras del Ejército'),(83,1,'Unidad Humanitaria y de Rescate MDN'),(84,1,'Unidad Médica del Ejército de Guatemala'),(85,1,'Unidad Militar de Apoyo a Emergencias MDN'),(86,1,'Unidad Naval del Ejército'),(87,1,'Unidad de Seguridad Presidencial'),(88,1,'Unidad de Inteligencia Militar'),(89,1,'Zona Militar de Reservas');

INSERT INTO `grado` VALUES (1,1,'Civil'),(2,1,'Soldado de Segunda'),(3,1,'Soldado de Primera'),(4,1,'Subteniente'),(5,1,'Planillero'),(6,1,'Cabo'),(7,1,'Sargento Segundo'),(8,1,'Sargento Mayor'),(9,1,'Sargento Mayor Comandante de Pelotón'),(10,1,'Sargento Primero'),(11,1,'Sargento Técnico'),(12,1,'Marinero de Tercera'),(13,1,'Marinero de Segunda'),(14,1,'Marinero de Primera'),(15,1,'Maestre Técnico'),(16,1,'Maestre Especialista'),(17,1,'Maestre Mayor'),(18,1,'Teniente Coronel'),(19,1,'Teniente de Navío'),(20,1,'Teniente de Fragata'),(21,1,'Capitán Segundo'),(22,1,'Vicealmirante'),(23,1,'Contramaestre'),(24,1,'Almirante'),(25,1,'Alférez de Fragata'),(26,1,'Alférez de Navío'),(27,1,'Capitán de Fragata'),(28,1,'Capitán de Corbeta'),(29,1,'Capitán Primero'),(30,1,'Mayor'),(31,1,'General de Brigada'),(32,1,'Coronel'),(33,1,'General de División');

INSERT INTO `motivo` VALUES (101,1,'Alta'),(102,1,'Ascenso'),(103,1,'Cambio de Plaza'),(104,1,'Curso CIORA'),(105,1,'Curso Francotirador'),(106,1,'Curso Galonista Profesional'),(107,1,'Curso Kabil'),(108,1,'Curso Liderazgo'),(109,1,'Curso Sargento Mayor CP'),(110,1,'Desvinculacion'),(201,1,'Especifica'),(202,1,'Psicologica'),(203,1,'Meom'),(204,1,'Especifica y Psicologica'),(205,1,'Especifica y Meom'),(206,1,'Psicologica y Específico'),(207,1,'Psicologica y Meom'),(208,1,'Especifica, Psicologica y Meom'),(209,1,'Licencia de conducir falsa'),(210,1,'No Aplica');

INSERT INTO `poblacion` VALUES (1,1,'Civiles'),(2,1,'Planilleros'),(3,1,'Tropas'),(4,1,'Especialistas'),(5,1,'Oficiales Asimilados'),(6,1,'Oficiales de Carrera');

INSERT INTO `usuario` VALUES  ('1724271260706', 1,'Alvaro Pur','51125144','apurg', 'admin', '187e3ef34c5be80a5b1fdb346dd190189f08a2c0',1,1,1,1);


DELIMITER $$

CREATE PROCEDURE PivotPreguntasRespuestas()
BEGIN
    -- Eliminar la tabla temporal si ya existe
    DROP TEMPORARY TABLE IF EXISTS temp_respuestas;

    -- Crear una tabla temporal para numerar las respuestas
    CREATE TEMPORARY TABLE temp_respuestas AS
    SELECT 
        r.PREGUNTA,
        r.RESPUESTA,
        r.ESCORRECTA,
        p.ENUNCIADO,
        p.PUNTEO,  -- Añadir el punteo de la pregunta
        p.ESTADO AS estado_pregunta,
        r.ESTADO AS estado_respuesta,
        (@row_number := IF(@pregunta = r.PREGUNTA, @row_number + 1, 1)) AS row_num,
        @pregunta := r.PREGUNTA AS dummy
    FROM 
        (SELECT @row_number := 0, @pregunta := 0) AS vars, respuesta r
    LEFT JOIN 
        pregunta p ON r.PREGUNTA = p.CODIGO_PREGUNTA
    WHERE p.ESTADO = 1  -- Solo considerar preguntas activas
    ORDER BY 
        r.PREGUNTA, r.CODIGO_RESPUESTA;

    -- Actualizar todas las respuestas de preguntas eliminadas usando una clave en la condición WHERE
    UPDATE respuesta r
    LEFT JOIN pregunta p ON r.PREGUNTA = p.CODIGO_PREGUNTA
    SET r.ESTADO = 0
    WHERE p.ESTADO = 0 AND r.CODIGO_RESPUESTA IS NOT NULL;  -- Se utiliza la clave CODIGO_RESPUESTA

    -- Crear la consulta dinámica
    SET @sql = 'SELECT t.PREGUNTA AS CODIGO_PREGUNTA, t.ENUNCIADO, t.PUNTEO';  -- Incluir el punteo

    -- Obtener el número máximo de respuestas por pregunta
    SELECT MAX(row_num) INTO @max_respuestas FROM temp_respuestas;

    -- Generar columnas dinámicas para cada respuesta
    SET @i = 1;
    WHILE @i <= @max_respuestas DO
        SET @sql = CONCAT(@sql, ', MAX(CASE WHEN row_num = ', @i, ' THEN t.RESPUESTA ELSE NULL END) AS respuesta', @i);
        SET @sql = CONCAT(@sql, ', MAX(CASE WHEN row_num = ', @i, ' THEN t.ESCORRECTA ELSE NULL END) AS esCorrecta', @i);
        SET @i = @i + 1;
    END WHILE;

    -- Completar el resto de la consulta
    SET @sql = CONCAT(@sql, ' FROM temp_respuestas t WHERE t.estado_pregunta = 1 GROUP BY t.PREGUNTA, t.ENUNCIADO, t.PUNTEO');

    -- Preparar y ejecutar la consulta
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

    -- Eliminar la tabla temporal
    DROP TEMPORARY TABLE IF EXISTS temp_respuestas;
END$$

DELIMITER ;

CALL PivotPreguntasRespuestas();

-- Datos de Prueba
INSERT INTO pregunta (CODIGO_PREGUNTA, ESTADO, ENUNCIADO, PUNTEO, USUARIO_INGRESO, FECHA_INGRESO) VALUES
(1, 1, '¿Qué día es hoy?', 2.00, '1724271260706', NOW()),
(2, 1, '¿Cómo me llamo?', 2.00, '1724271260706', NOW()),
(3, 1, '¿Ganó el Barça?', 1.00, '1724271260706', NOW()),
(4, 1, '¿Cuál es la capital de Francia?', 2.00, '1724271260706', NOW()),
(5, 1, '¿Cuánto es 5 + 5?', 2.00, '1724271260706', NOW()),
(6, 1, '¿Cuál es el color del cielo en un día soleado?', 2.00, '1724271260706', NOW()),
(7, 1, '¿Qué animal ladra?', 2.00, '1724271260706', NOW()),
(8, 1, '¿Cuánto es 8 * 7?', 2.00, '1724271260706', NOW()),
(9, 1, '¿Quién pintó La Mona Lisa?', 2.00, '1724271260706', NOW()),
(10, 1, '¿Cuál es el planeta más cercano al Sol?', 2.00, '1724271260706', NOW()),
(11, 1, '¿Quién escribió Hamlet?', 2.00, '1724271260706', NOW()),
(12, 1, '¿Cuántos colores tiene un arcoíris?', 2.00, '1724271260706', NOW()),
(13, 1, '¿Cuántos días tiene una semana?', 2.00, '1724271260706', NOW()),
(14, 1, '¿Cuál es el metal más ligero?', 2.00, '1724271260706', NOW()),
(15, 1, '¿Qué gas respiran los humanos?', 2.00, '1724271260706', NOW()),
(16, 1, '¿Cuál es el océano más grande del mundo?', 2.00, '1724271260706', NOW()),
(17, 1, '¿Qué instrumento tiene teclas blancas y negras?', 2.00, '1724271260706', NOW()),
(18, 1, '¿Qué planeta es conocido como el planeta rojo?', 2.00, '1724271260706', NOW()),
(19, 1, '¿Qué mes tiene el día más corto del año?', 2.00, '1724271260706', NOW()),
(20, 1, '¿Cuál es el río más largo del mundo?', 2.00, '1724271260706', NOW()),
(21, 1, '¿Cuántos huesos tiene el cuerpo humano?', 2.00, '1724271260706', NOW()),
(22, 1, '¿Cuál es el animal más grande del mundo?', 2.00, '1724271260706', NOW()),
(23, 1, '¿Qué órgano bombea la sangre?', 2.00, '1724271260706', NOW()),
(24, 1, '¿Quién inventó la bombilla?', 2.00, '1724271260706', NOW());

INSERT INTO respuesta (CODIGO_RESPUESTA, ESTADO, RESPUESTA, ESCORRECTA, PREGUNTA, USUARIO_INGRESO, FECHA_INGRESO) VALUES
-- Respuestas para la pregunta 1
(1, 1, 'Lunes', 0, 1, '1724271260706', NOW()),
(2, 1, 'Viernes', 1, 1, '1724271260706', NOW()),
(3, 1, 'Domingo', 0, 1, '1724271260706', NOW()),

-- Respuestas para la pregunta 2
(4, 1, 'Pedro', 0, 2, '1724271260706', NOW()),
(5, 1, 'Juan', 1, 2, '1724271260706', NOW()),
(6, 1, 'Lucas', 0, 2, '1724271260706', NOW()),

-- Respuestas para la pregunta 3
(7, 1, 'Sí', 1, 3, '1724271260706', NOW()),
(8, 1, 'No', 0, 3, '1724271260706', NOW()),
(9, 1, 'No sé', 0, 3, '1724271260706', NOW()),

-- Respuestas para la pregunta 4
(10, 1, 'Londres', 0, 4, '1724271260706', NOW()),
(11, 1, 'París', 1, 4, '1724271260706', NOW()),
(12, 1, 'Berlín', 0, 4, '1724271260706', NOW()),

-- Respuestas para la pregunta 5
(13, 1, '10', 1, 5, '1724271260706', NOW()),
(14, 1, '15', 0, 5, '1724271260706', NOW()),
(15, 1, '20', 0, 5, '1724271260706', NOW()),

-- Respuestas para la pregunta 6
(16, 1, 'Azul', 1, 6, '1724271260706', NOW()),
(17, 1, 'Verde', 0, 6, '1724271260706', NOW()),
(18, 1, 'Amarillo', 0, 6, '1724271260706', NOW()),

-- Respuestas para la pregunta 7
(19, 1, 'Perro', 1, 7, '1724271260706', NOW()),
(20, 1, 'Gato', 0, 7, '1724271260706', NOW()),
(21, 1, 'Elefante', 0, 7, '1724271260706', NOW()),

-- Respuestas para la pregunta 8
(22, 1, '56', 1, 8, '1724271260706', NOW()),
(23, 1, '64', 0, 8, '1724271260706', NOW()),
(24, 1, '72', 0, 8, '1724271260706', NOW()),

-- Respuestas para la pregunta 9
(25, 1, 'Da Vinci', 1, 9, '1724271260706', NOW()),
(26, 1, 'Picasso', 0, 9, '1724271260706', NOW()),
(27, 1, 'Van Gogh', 0, 9, '1724271260706', NOW()),

-- Respuestas para la pregunta 10
(28, 1, 'Mercurio', 1, 10, '1724271260706', NOW()),
(29, 1, 'Venus', 0, 10, '1724271260706', NOW()),
(30, 1, 'Tierra', 0, 10, '1724271260706', NOW()),

-- Respuestas para la pregunta 11
(31, 1, 'Shakespeare', 1, 11, '1724271260706', NOW()),
(32, 1, 'Cervantes', 0, 11, '1724271260706', NOW()),
(33, 1, 'Hemingway', 0, 11, '1724271260706', NOW()),

-- Respuestas para la pregunta 12
(34, 1, '7', 1, 12, '1724271260706', NOW()),
(35, 1, '6', 0, 12, '1724271260706', NOW()),
(36, 1, '8', 0, 12, '1724271260706', NOW()),

-- Respuestas para la pregunta 13
(37, 1, '7', 1, 13, '1724271260706', NOW()),
(38, 1, '5', 0, 13, '1724271260706', NOW()),
(39, 1, '10', 0, 13, '1724271260706', NOW()),

-- Respuestas para la pregunta 14
(40, 1, 'Litio', 1, 14, '1724271260706', NOW()),
(41, 1, 'Hierro', 0, 14, '1724271260706', NOW()),
(42, 1, 'Cobre', 0, 14, '1724271260706', NOW()),

-- Respuestas para la pregunta 15
(43, 1, 'Oxígeno', 1, 15, '1724271260706', NOW()),
(44, 1, 'Dióxido de Carbono', 0, 15, '1724271260706', NOW()),
(45, 1, 'Nitrógeno', 0, 15, '1724271260706', NOW()),

-- Respuestas para la pregunta 16
(46, 1, 'Océano Pacífico', 1, 16, '1724271260706', NOW()),
(47, 1, 'Océano Atlántico', 0, 16, '1724271260706', NOW()),
(48, 1, 'Océano Índico', 0, 16, '1724271260706', NOW()),

-- Respuestas para la pregunta 17
(49, 1, 'Piano', 1, 17, '1724271260706', NOW()),
(50, 1, 'Guitarra', 0, 17, '1724271260706', NOW()),
(51, 1, 'Violín', 0, 17, '1724271260706', NOW()),

-- Respuestas para la pregunta 18
(52, 1, 'Marte', 1, 18, '1724271260706', NOW()),
(53, 1, 'Júpiter', 0, 18, '1724271260706', NOW()),
(54, 1, 'Saturno', 0, 18, '1724271260706', NOW()),

-- Respuestas para la pregunta 19
(55, 1, 'Diciembre', 1, 19, '1724271260706', NOW()),
(56, 1, 'Enero', 0, 19, '1724271260706', NOW()),
(57, 1, 'Febrero', 0, 19, '1724271260706', NOW()),

-- Respuestas para la pregunta 20
(58, 1, 'Amazonas', 1, 20, '1724271260706', NOW()),
(59, 1, 'Nilo', 0, 20, '1724271260706', NOW()),
(60, 1, 'Yangtsé', 0, 20, '1724271260706', NOW()),

-- Respuestas para la pregunta 21
(61, 1, '206', 1, 21, '1724271260706', NOW()),
(62, 1, '208', 0, 21, '1724271260706', NOW()),
(63, 1, '204', 0, 21, '1724271260706', NOW()),

-- Respuestas para la pregunta 22
(64, 1, 'Ballena Azul', 1, 22, '1724271260706', NOW()),
(65, 1, 'Elefante', 0, 22, '1724271260706', NOW()),
(66, 1, 'Jirafa', 0, 22, '1724271260706', NOW()),

-- Respuestas para la pregunta 23
(67, 1, 'Corazón', 1, 23, '1724271260706', NOW()),
(68, 1, 'Pulmón', 0, 23, '1724271260706', NOW()),
(69, 1, 'Riñón', 0, 23, '1724271260706', NOW()),

-- Respuestas para la pregunta 24
(70, 1, 'Thomas Edison', 1, 24, '1724271260706', NOW()),
(71, 1, 'Nikola Tesla', 0, 24, '1724271260706', NOW()),
(72, 1, 'Benjamin Franklin', 0, 24, '1724271260706', NOW());

DELIMITER //

CREATE PROCEDURE ObtenerDatosAsignacionPorDPIyExamen(IN p_dpi VARCHAR(25), IN p_codigo_examen INT)
BEGIN
    SELECT 
        u.DPI,
        u.NOMBRE_COMPLETO,
        u.TELEFONO,
        g.NOMBRE_GRADO AS GRADO,
        p.NOMBRE_POBLACION AS POBLACION,
        d.NOMBRE_DEPARTAMENTO AS RESIDENCIA,
        c.NOMBRE_COMANDO AS COMANDO,
        e.FECHA_EVALUACION,
        m.NOMBRE_MOTIVO AS MOTIVO,
        em.DESCRIPCION AS EMPLEO

    FROM asignacion a
    INNER JOIN usuario u ON a.EVALUADO = u.DPI
    INNER JOIN examen e ON a.EXAMEN = e.CODIGO_EXAMEN
    
    -- Relaciones adicionales para obtener descripciones
    LEFT JOIN grado g ON u.GRADO = g.CODIGO_GRADO
    LEFT JOIN poblacion p ON u.POBLACION = p.CODIGO_POBLACION
    LEFT JOIN departamento_residencia d ON u.RESIDENCIA = d.CODIGO_DEPARTAMENTO
    LEFT JOIN comando c ON u.COMANDO = c.CODIGO_COMANDO
    LEFT JOIN motivo m ON e.MOTIVO = m.CODIGO_MOTIVO
    LEFT JOIN empleo em ON e.EMPLEO = em.CEOM

    WHERE u.DPI = p_dpi AND e.CODIGO_EXAMEN = p_codigo_examen;
END //
DELIMITER ;

DELIMITER //

CREATE PROCEDURE ObtenerDatosExamenPorUsuarioYExamen(IN p_dpi VARCHAR(25), IN p_codigo_examen INT)
BEGIN
    SELECT 
        u.NOMBRE_COMPLETO AS NOMBRE_EVALUADO,
        e.FECHA_EVALUACION,
        IFNULL(em.DESCRIPCION, 'Vacío') AS EMPLEO,
        
        -- Campos del detalle (Serie e Instrucción)
        IFNULL(d.SERIE, 'Vacío') AS SERIE,
        IFNULL(d.INSTRUCCION, 'Vacío') AS INSTRUCCION,
        
        -- Campos de la pregunta
        IFNULL(p.ENUNCIADO, 'Vacío') AS PREGUNTA,
        IFNULL(p.PUNTEO, 0) AS PUNTEO_PREGUNTA,
        
        -- Respuestas divididas en columnas
        MAX(CASE WHEN rnum = 1 THEN r.RESPUESTA END) AS OPCION1,
        MAX(CASE WHEN rnum = 2 THEN r.RESPUESTA END) AS OPCION2,
        MAX(CASE WHEN rnum = 3 THEN r.RESPUESTA END) AS OPCION3
        
    FROM asignacion a
    INNER JOIN usuario u ON a.EVALUADO = u.DPI
    INNER JOIN examen e ON a.EXAMEN = e.CODIGO_EXAMEN
    LEFT JOIN empleo em ON e.EMPLEO = em.CEOM
    LEFT JOIN detalle d ON e.CODIGO_EXAMEN = d.EXAMEN
    LEFT JOIN pregunta p ON d.PREGUNTA = p.CODIGO_PREGUNTA
    LEFT JOIN (
        SELECT 
            respuesta.*, 
            ROW_NUMBER() OVER(PARTITION BY pregunta ORDER BY CODIGO_RESPUESTA) AS rnum
        FROM respuesta
    ) r ON p.CODIGO_PREGUNTA = r.PREGUNTA
    WHERE u.DPI = p_dpi AND e.CODIGO_EXAMEN = p_codigo_examen
    GROUP BY u.NOMBRE_COMPLETO, e.FECHA_EVALUACION, e.MOTIVO, em.DESCRIPCION, d.SERIE, d.INSTRUCCION, p.ENUNCIADO, p.PUNTEO, p.CODIGO_PREGUNTA
    ORDER BY d.SERIE, p.CODIGO_PREGUNTA;
END //

DELIMITER ;